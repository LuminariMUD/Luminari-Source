name: Code Quality

on:
  push:
    branches: [master, main]
    paths:
      - 'src/**'
      - '.clang-format'
      - '.clang-tidy'
      - '.github/workflows/quality.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'src/**'
      - '.clang-format'
      - '.clang-tidy'
      - '.github/workflows/quality.yml'

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          find src -name '*.c' -o -name '*.h' | head -50 | xargs clang-format --dry-run --Werror 2>&1 || {
            echo "::error::Code formatting issues found. Run 'clang-format -i src/*.c src/*.h' locally."
            exit 1
          }

  lint:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy libmariadb-dev libssl-dev zlib1g-dev

      - name: Copy config headers
        run: |
          cp src/campaign.example.h src/campaign.h
          cp src/mud_options.example.h src/mud_options.h
          cp src/vnums.example.h src/vnums.h

      - name: Run clang-tidy on changed files
        run: |
          # Run on a subset of core files to start
          clang-tidy src/utils.c src/handler.c src/comm.c \
            --checks='-*,bugprone-*,cert-*,-cert-err33-c' \
            --warnings-as-errors='' \
            -- -I/usr/include/mariadb -Isrc 2>&1 | head -100 || true

  compile-check:
    name: Compile with Warnings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libmariadb-dev libssl-dev zlib1g-dev autoconf automake libtool

      - name: Copy config headers
        run: |
          cp src/campaign.example.h src/campaign.h
          cp src/mud_options.example.h src/mud_options.h
          cp src/vnums.example.h src/vnums.h

      - name: Configure with autotools
        run: |
          autoreconf -fvi
          ./configure

      - name: Build with strict warnings
        run: |
          make -j$(nproc) CFLAGS="-Wall -Wextra -Wno-unused-parameter -Wno-sign-compare" 2>&1 | tee build.log
          # Report warning count but don't fail (legacy codebase)
          WARN_COUNT=$(grep -c ": warning:" build.log || echo 0)
          echo "::notice::Compiler warnings: $WARN_COUNT"
